$(document).ready(function(){function t(t){var e=["th","st","nd","rd"],r=t%100;return t+(e[(r-20)%10]||e[r]||e[0])}function e(e){function r(t){t.children&&(t._children=t.children,t._children.forEach(r),t.children=null,d3.select("#node-"+t.id).select(".collapse-text").text("+"))}function a(t){var r=usersFlowTree.nodes(e).reverse(),a=usersFlowTree.links(r);r.forEach(function(t){if(t.parent)for(var e=0;e<t.parent.children.length;e++)t.parent.children[e].sid==t.sid&&(t.yOffset=e,void 0!=t.parent.yOffset&&(t.yOffset+=t.parent.yOffset));void 0===t.yOffset&&(t.yOffset=0),t.x=t.yOffset*(d+50)+60,t.y=t.depth*(l+c)});var s=usersFlowSVG.selectAll("g.node").data(r,function(t){return t.id||(t.id=++p)}),o=s.enter().append("g").attr("class","node").attr("id",function(t){return"node-"+t.id}).attr("data-depth",function(t){return t.depth+1}).attr("transform",function(e){return"translate("+(t.y0+c/2)+","+t.x0+")"});o.append("rect").attr("width",l).attr("height",d).attr("stroke","rgb(214,214,214)").attr("stroke-width",1).style("fill","rgb(255,255,255)"),o.append("image").attr("width",l-20).attr("height",d-100).attr("x",10).attr("y",10).attr("xlink:href",function(t){return t.image}).on("error",function(){var t=$(this);t.attr("href",t.attr("href").replace("screen-thumbs","screen-elements"))}).style("cursor","pointer").on("click",function(t){i(t)});var h=o.append("text").attr("x",l/2).attr("y",d-60).attr("text-anchor","middle").style("font-size","12px").style("fill","rgb(118,118,118)").text(function(t){return t.title.length>15?t.title.substring(0,14).trim()+"...":t.title});h.append("title").text(function(t){return t.title.length>15?t.title:""}),o.append("text").attr("x",l/2).attr("y",d-30).attr("text-anchor","middle").style("font-size","12px").text(function(t){return t.sessions+(t.sessions>1?" sessions":" session")}),o.append("text").attr("x",l/2).attr("y",d-10).attr("text-anchor","middle").style("font-size","12px").text(function(t){return t.dropoffs+(t.dropoffs>1?" drop-offs":" drop-off")+" ("+Math.round(100*t.dropoffs/t.sessions*100)/100+"%)"}),o.append("circle").attr("cx",l).attr("cy",d/2).attr("r","10").attr("display",function(t){return t.children&&t.children.length>0||t._children&&t._children.length>0?"block":"none"}),o.append("text").attr("class","collapse-text").attr("x",l).attr("y",d/2).attr("dy",".35em").attr("text-anchor","middle").text(function(t){return t.children&&t.children.length>0?"-":"+"}).on("click",n).attr("display",function(t){return t.children&&t.children.length>0||t._children&&t._children.length>0?"block":"none"}),t.children&&t.children.length>0?d3.select("#node-"+t.id).select(".collapse-text").text("-"):d3.select("#node-"+t.id).select(".collapse-text").text("+");var u=s.transition().duration(g).attr("transform",function(t){return"translate("+(t.y+c/2)+","+t.x+")"});u.select("text").style("fill-opacity",1);var f=(s.exit().transition().duration(g).attr("transform",function(e){return"translate("+(t.y+c/2)+","+t.x+")"}).remove(),usersFlowSVG.selectAll(".link").data(a,function(t){return t.target.id})),w=f.enter().insert("g",":first-child").attr("class","link").attr("data-sessions",function(t){return t.target.sessions});w.append("path").attr("x",l+c/2).attr("y",l+c/2).attr("d",function(e){var r={x:t.x0,y:t.y0};return v({source:r,target:r})});var y=f.transition().duration(g);y.select("path").attr("d",v);var m=f.exit().transition().duration(g).remove();m.select("path").attr("d",function(e){var r={x:t.x,y:t.y};return v({source:r,target:r})}),usersFlowSVG.attr("transform","translate(0,0)"),r.forEach(function(t){t.x0=t.x,t.y0=t.y})}function n(t){t.children?(t._children=t.children,t.children=null):(t.children=t._children,t._children=null),void 0===t.state||"closed"==t.state?t.state="open":t.state="closed",t.parent&&t.parent.children.forEach(function(e){t!==e&&r(e)}),s(t),a(t)}function s(e){setTimeout(function(){d3.selectAll("#usersFlow .link rect").remove(),d3.selectAll("#usersFlow .link text").remove(),d3.selectAll("#usersFlow .link").each(function(){var t=d3.select(this),e=this.getBBox(),r=Math.floor(e.x+e.width/2),a=Math.floor(e.y+e.height/2);t.append("rect").attr("x",r-12).attr("y",a-12).attr("rx",2).attr("ry",2).attr("width",24).attr("height",24),t.append("text").attr("x",r).attr("y",a).attr("dy",".5em").attr("text-anchor","middle").text(t.attr("data-sessions"))}),d3.selectAll("#usersFlow .depth").remove(),h=1,$("#usersFlow .node").each(function(){var t=parseInt($(this).attr("data-depth"));h<t&&(h=t)});for(var e=usersFlowSVG[0][0].getBBox().height+40,r=0;r<h;r++){var a=usersFlowSVG.insert("g",":first-child").attr("class","depth").attr("transform",function(t){return"translate("+(l+c)*r+",0)"});a.append("rect").attr("width",l+c).attr("height",40).attr("stroke","").attr("stroke-width",0).style("fill",r%2==0?"rgb(90,109,125)":"rgb(78,97,113)"),a.append("text").attr("x",l/2).attr("y",15).attr("dy",".5em").attr("fill","rgb(255,255,255)").text(r>0?t(r)+" Interaction":"Start Screen"),a.append("rect").attr("width",l+c).attr("height",e).attr("y",40).attr("stroke","").attr("stroke-width",0).style("fill",r%2==0?"rgb(255,255,255)":"rgb(247,247,247)")}usersFlowSVGParent.attr("height",usersFlowSVG[0][0].getBBox().height).attr("width",usersFlowSVG[0][0].getBBox().width),$("#usersFlow").scrollLeft(usersFlowSVG[0][0].getBBox().width,500)},g)}function i(t){var e=t.sid,r=$("#heatmapModalScreenContainer").hide(),a=$("#heatmapModalCanvasContainer").hide(),n=$("#heatmapModal .cf-spinner").show(),s=[],i=deviceWidth/parseInt(project.width);if(null!=analyzeData.analyze)for(var o=0;o<analyzeData.analyze.length;o++)for(var l=GetAnalyzeScript(analyzeData.analyze[o].script),d=0;d<l.length;d++)l[d].length>6&&l[d][1]==e&&0!=l[d][3]&&0!=l[d][4]&&s.push([parseInt(l[d][3])*i,parseInt(l[d][4])*i,1]);var c=t.image.replace("screen-thumbs","screen-elements"),h=$("<div class='heatmap-screen'><img src='"+c+"'></div>");$("#heatmapModalContainer > div > div").width(deviceWidth),$("#heatmapModal").modal("show"),window.setTimeout(function(){n.hide(),r.html(h).show(),a.attr("width",deviceWidth).attr("height",h.height()).show();try{var t=analyzeData.analyze.length,e=simpleheat("heatmapModalCanvasContainer").data(s).max(t);e.radius(25,0),e.draw()}catch(t){}},800)}$("#usersFlow").empty();var o=$("#analyzeUsersFlowContainer"),l=120,d=deviceHeight*(l/deviceWidth)+50,c=100,h=2,u=o.width(),f=o.height(),p=0,g=750,v=d3.svg.diagonal().source(function(t){return{x:t.source.x+d/2,y:t.source.y+l+c/2}}).target(function(t){return{x:t.target.x+d/2,y:t.target.y+c/2}}).projection(function(t){return[t.y,t.x]});usersFlowTree=d3.layout.tree().size([f,u]).nodeSize([150,150]),usersFlowSVGParent=d3.select("#usersFlow").append("svg").attr("width",u).attr("height",f),usersFlowSVG=usersFlowSVGParent.append("g"),e.x0=f/2,e.y0=0,e.children.forEach(r),a(e),s(e);d3.select("body").append("div").attr("class","tooltip").style("display","none").style("opacity",1e-6)}var r=1;$("a[href='#analyzeUsersFlowContainer']").click(function(){$("#analyzeUsersFlowContainer > .cf-spinner").show(),window.setTimeout(function(){try{e(jQuery.extend(!0,{},analyzeData.usersflow[0]))}catch(t){}$("#analyzeUsersFlowContainer > .cf-spinner").hide(),$("#analyzeSidebar li").removeClass("active"),$("#analyzeSidebar li a[href='#analyzeUsersFlowContainer']").parent("li").addClass("active");try{window.location.host.indexOf("canvasflip.com")!==-1&&Intercom("trackEvent","Opened Conversion Funnel")}catch(t){}},800)}),$("#printUsersFlow").click(function(){var t=document.getElementById("usersFlow"),e=window.open("","","left=0,top=0,width=800,height=900,toolbar=0,scrollbars=0,status=0");e.document.write(t.innerHTML),e.document.write('<link href="Library/jqEscortCommon.css" rel="Stylesheet" />'),e.document.close(),e.focus(),e.print(),e.close()}),$("#divZoomUsersFlow .cf-slider").slider({orientation:"horizontal",range:"min",value:1,min:.2,step:.1,max:2,change:function(t,e){r=e.value;var a=/translate\((.*?)\)/.exec(usersFlowSVG.attr("transform"));usersFlowSVG.attr("transform",(a.length>0?a[0]:"")+" scale("+r+")")},slide:function(t,e){r=e.value,usersFlowSVG.attr("transform",usersFlowSVG.attr("transform")+" scale("+r+")")}}),$("#divZoomOutUsersFlow").on("click",function(){var t=$("#divZoomUsersFlow .cf-slider");t.slider("value",t.slider("value")-.2),t.trigger("slidechange")}),$("#divZoomInUsersFlow").on("click",function(){var t=$("#divZoomUsersFlow .cf-slider");t.slider("value",t.slider("value")+.2),t.trigger("slidechange")}),$("#userflowExportPdf").on("click",function(){$("#userflowExportPdf").button("loading"),$("#userflowExportPdf").prop("disabled","true"),$("#analyzeScreenflow").scrollTop(0);var t=$("#analyzeScreenflow>div"),e=t.outerHeight(!0),r=t.outerWidth(!0),a=t.find(".userflow-screen"),n=a.length;a.each(function(){var a=$(this),s=document.createElement("img"),i=document.createElement("canvas"),o=i.getContext("2d"),l=a.attr("src");s.setAttribute("crossOrigin","anonymous"),s.onload=function(){i.width=s.width,i.height=s.height,o.drawImage(s,0,0);var l=i.toDataURL("image/png"),d=new Image;if(d.setAttribute("src",l),d.className="svgTempImage",$(d).insertAfter(a),a.hide().addClass("svgTempSvg"),n--,0==n){t.css("background","#fff");var c=r+t.offset().left+80,h=e+t.offset().top;html2canvas(t.get(0),{allowTaint:!0,background:"#fff",width:c,height:h,onrendered:function(a){var n=document.createElement("canvas");n.setAttribute("width",r),n.setAttribute("height",e);var s=n.getContext("2d");s.drawImage(a,0,0,a.width,a.height,0,0,r,e),s.fillStyle="#FFFFFF",s.fill();var i="p";e<=1240&&(i="l");var o=.264583*r,l=.264583*e,d=new jsPDF(i,"mm",[o,l]);d.addImage(n,"PNG",0,0,o,l),d.save(project.title+".pdf"),t.find(".svgTempImage").remove(),t.find(".svgTempSvg").show().removeClass("svgTempSvg"),$("#userflowExportPdf").button("reset"),$("#userflowExportPdf").removeAttr("disabled")}})}},s.src=l})}),$("#userVideoShare").on("click",function(){$("#videoShareBoxURL").hide(),$("#videoShareModal").modal("show"),$("#videoShareModalSpinner").show(),$.ajax({url:"../app/svcs/analyze/getUserVideoShareLink.php",type:"POST",data:{id:$("#analyzeUsers .analyze-user.active").attr("data-id")},cache:!1,success:function(t){"success"==t.result?($("#videoShareModalSpinner").hide(),$("#videoShareBoxURL").show(),$("#videoShareLinkText").attr("value",t.link),$(".modal-backdrop").css("display","none")):alertify.error("User share video link can't be generated now")},error:function(t){alertify.error("User share video link can't be generated now")},fail:function(t){alertify.error("User share video link can't be generated now")}})})});